# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ - 2025-10-07

## üî¥ –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ª–æ–≥–∏–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞–ª–∏ –æ—à–∏–±–∫—É **403 Forbidden** –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –∏–ª–∏ —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

### –°–∏–º–ø—Ç–æ–º—ã:
```
GET https://admin.news.rmevent.ru/api/auth/me 403 (Forbidden)
Failed to load user: Error: Failed to get current user
```

–í –ª–æ–≥–∞—Ö backend:
```
POST /api/auth/login HTTP/1.1" 200 OK  ‚Üê –õ–æ–≥–∏–Ω —É—Å–ø–µ—à–µ–Ω
GET /api/auth/me HTTP/1.1" 403 Forbidden  ‚Üê –°—Ä–∞–∑—É –ø–æ—Å–ª–µ 403!
```

## üîç –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
1. **Frontend** —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç JWT —Ç–æ–∫–µ–Ω –≤ **HttpOnly cookie** (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
2. **Frontend API routes** (`/pages/api/auth/me.js`, `/pages/api/users/index.js`) —á–∏—Ç–∞—é—Ç —Ç–æ–∫–µ–Ω –∏–∑ cookie –∏ –ø–µ—Ä–µ–¥–∞—é—Ç –≤ backend —á–µ—Ä–µ–∑ Authorization header
3. **Backend** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω –∏–∑ Authorization header

### –ü—Ä–æ–±–ª–µ–º–∞ –≤ nginx:
Nginx –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–ª `/api/auth/*` –∏ `/api/users/*` **–ù–ê–ü–†–Ø–ú–£–Æ** –Ω–∞ backend, –º–∏–Ω—É—è frontend API routes:

```nginx
# –°–¢–ê–†–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
location /api {
    proxy_pass http://backend:8000;  # ‚Üê –í—Å–µ /api/* –∏–¥—É—Ç –Ω–∞ backend
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ó–∞–ø—Ä–æ—Å —Å –±—Ä–∞—É–∑–µ—Ä–∞: `GET /api/auth/me` —Å HttpOnly cookie
- Nginx ‚Üí Backend –Ω–∞–ø—Ä—è–º—É—é (–ë–ï–ó Authorization header!)
- Backend –Ω–µ –≤–∏–¥–∏—Ç —Ç–æ–∫–µ–Ω–∞ ‚Üí 403 Forbidden

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–ò–∑–º–µ–Ω–µ–Ω –ø–æ—Ä—è–¥–æ–∫ `location` –±–ª–æ–∫–æ–≤ –≤ nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:

```nginx
# –ù–û–í–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)

# 1. Auth, Users, Settings —á–µ—Ä–µ–∑ frontend (–¥–ª—è —á—Ç–µ–Ω–∏—è cookies)
location ~ ^/api/(auth|users|settings)/ {
    proxy_pass http://frontend:3000;
}

# 2. Next.js proxy routes
location /api/proxy {
    proxy_pass http://frontend:3000;
}

# 3. –û—Å—Ç–∞–ª—å–Ω—ã–µ API –Ω–∞–ø—Ä—è–º—É—é –Ω–∞ backend
location /api {
    proxy_pass http://backend:8000;
}
```

### –ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. –ó–∞–ø—Ä–æ—Å `GET /api/auth/me` –ø–æ–ø–∞–¥–∞–µ—Ç –≤ **–ø–µ—Ä–≤—ã–π** –±–ª–æ–∫ (regex `^/api/(auth|users|settings)/`)
2. Nginx –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –Ω–∞ **frontend:3000**
3. Frontend API route (`/pages/api/auth/me.js`):
   - –ß–∏—Ç–∞–µ—Ç —Ç–æ–∫–µ–Ω –∏–∑ `req.cookies.auth_token`
   - –î–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ backend —Å `Authorization: Bearer ${token}`
4. Backend –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚úÖ

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```
INFO: 172.18.0.5:xxx - "GET /api/auth/me HTTP/1.1" 403 Forbidden
```

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```
INFO: Verifying token: eyJhbGciOiJIUzI1NiIs...
INFO: Token verified for username: admin
INFO: User authenticated: admin, role: UserRole.ADMIN
INFO: "GET /api/auth/me HTTP/1.1" 200 OK  ‚Üê ‚úÖ SUCCESS!
```

## üîß –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ù–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:
```bash
# Backup —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
cp /opt/medical-news/deployed/nginx-server.conf \
   /opt/medical-news/deployed/nginx-server.conf.backup-$(date +%Y%m%d-%H%M%S)

# –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
scp nginx-server.conf root@SERVER:/opt/medical-news/deployed/

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å nginx
docker restart medical-news-nginx
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
docker exec medical-news-nginx nginx -t

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker logs -f medical-news-backend | grep "auth"
```

## üìù –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### –ü–æ—Ä—è–¥–æ–∫ location –±–ª–æ–∫–æ–≤ –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ!
Nginx –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç location –≤ —Å–ª–µ–¥—É—é—â–µ–º –ø–æ—Ä—è–¥–∫–µ:
1. **–¢–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è**: `location = /exact`
2. **Regex —Å ^~**: `location ^~ /priority`
3. **Regex**: `location ~ /pattern/` ‚Üê –ù–∞—à —Å–ª—É—á–∞–π
4. **–ü—Ä–µ—Ñ–∏–∫—Å–Ω—ã–µ**: `location /api` ‚Üê Fallback

–ü–æ—ç—Ç–æ–º—É regex `location ~ ^/api/(auth|users|settings)/` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è **–î–û** –ø—Ä–µ—Ñ–∏–∫—Å–Ω–æ–≥–æ `location /api`

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å HttpOnly cookies
- ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–æ**: –¢–æ–∫–µ–Ω –≤ HttpOnly cookie (–∑–∞—â–∏—Ç–∞ –æ—Ç XSS)
- ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–æ**: Frontend API routes —á–∏—Ç–∞—é—Ç cookie –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–æ**: Backend –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω –≤ Authorization header
- ‚ùå **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ**: –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ backend –±–µ–∑ —Ç–æ–∫–µ–Ω–∞

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –±—É–¥—É—â–µ–µ

1. **–ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ**: –í—Å–µ auth-related endpoints –¥–æ–ª–∂–Ω—ã –∏–¥—Ç–∏ —á–µ—Ä–µ–∑ frontend API routes
2. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: –ß–µ—Ç–∫–æ —É–∫–∞–∑—ã–≤–∞—Ç—å –∫–∞–∫–∏–µ endpoints —Ç—Ä–µ–±—É—é—Ç HttpOnly cookies
3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—è—Ç—å flow –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞ –∫–∞–∂–¥–æ–º deploy
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –ê–ª–µ—Ä—Ç—ã –Ω–∞ 403 –æ—à–∏–±–∫–∏ –≤ /api/auth/* –∏ /api/users/*

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `nginx-server.conf` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è nginx (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞)
- `frontend/pages/api/auth/me.js` - API route –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `frontend/pages/api/users/index.js` - API route –¥–ª—è —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `backend/api/dependencies.py` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ backend
- `backend/api/auth.py` - endpoints –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## ‚úÖ –°—Ç–∞—Ç—É—Å

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** 2025-10-07
**–†–∞–∑–≤–µ—Ä–Ω—É—Ç–æ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:** admin.news.rmevent.ru
**–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:** ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
