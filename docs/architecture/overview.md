# Обзор архитектуры - Система медицинских новостей

## Описание системы

Система медицинских новостей "Medical News Automation System" представляет собой комплексное решение для автоматизации создания и публикации новостных материалов для медицинских платформ. Система использует технологии искусственного интеллекта для анализа, обработки и генерации контента.

## Основные компоненты

### 1. Backend (FastAPI)
- **Расположение:** `/backend/`
- **Технологии:** Python 3.11+, FastAPI, SQLModel, SQLite
- **Назначение:** REST API для обработки запросов, интеграция с AI сервисами, управление данными

### 2. Frontend (Next.js)
- **Расположение:** `/frontend/`
- **Технологии:** Next.js 14, React 18, TailwindCSS, TypeScript
- **Назначение:** Веб-интерфейс для управления системой и мониторинга

### 3. База данных
- **Тип:** SQLite (для разработки), PostgreSQL (для продакшена)
- **ORM:** SQLModel
- **Назначение:** Хранение статей, пользователей, настроек, логов операций

## Архитектурные слои

### Backend архитектура

```
backend/
├── main.py                 # Точка входа, FastAPI app
├── api/                    # REST API эндпоинты
│   ├── auth.py            # Аутентификация
│   ├── news.py            # Управление новостями
│   ├── news_generation.py # Генерация контента
│   ├── users.py           # Управление пользователями
│   ├── expenses.py        # Учет расходов
│   ├── monitoring.py      # Мониторинг системы
│   └── admin.py           # Административные функции
├── core/                   # Основные компоненты
│   ├── config.py          # Конфигурация
│   └── env_validator.py   # Валидация окружения
├── database/              # Слой данных
│   ├── models.py          # SQLModel модели
│   ├── connection.py      # Подключение к БД
│   ├── service.py         # Сервисы работы с БД
│   └── migrate.py         # Миграции
├── services/              # Бизнес-логика
│   ├── ai_service.py      # AI интеграция
│   ├── news_parser.py     # Парсинг новостей
│   ├── auth_service.py    # Аутентификация
│   ├── settings_service.py # Настройки
│   └── scheduler.py       # Планировщик задач
└── middleware/            # Промежуточное ПО
    └── rate_limiter.py    # Ограничение запросов
```

### Frontend архитектура

```
frontend/
├── pages/                 # Next.js страницы
│   ├── index.js          # Главная страница
│   ├── login.js          # Авторизация
│   ├── monitoring.js     # Мониторинг
│   ├── published.js      # Опубликованные новости
│   └── settings.js       # Настройки
├── components/           # React компоненты
│   ├── ui/              # UI компоненты
│   ├── Layout.js        # Основной layout
│   ├── Navigation.js    # Навигация
│   └── ProtectedRoute.js # Защищенные маршруты
├── contexts/            # React контексты
│   └── AuthContext.js   # Контекст аутентификации
└── utils/               # Утилиты
    ├── api.js          # API клиент
    └── timezone.js     # Работа с часовыми поясами
```

## Основные функции системы

### 1. Парсинг новостей
- Автоматический сбор новостей из медицинских источников
- Поддержка источников: РИА Новости, Медвестник, АИГ, Remedium, РБК Медицина
- Планировщик ежедневного парсинга (02:00 MSK)
- Отслеживание дубликатов и статистики

### 2. Генерация контента
- AI-генерация новостных материалов на основе исходных статей
- Создание SEO-оптимизированных заголовков и описаний
- Генерация изображений для статей
- Создание анонсов для Telegram

### 3. Управление публикациями
- Интеграция с Bitrix CMS для публикации
- Отложенная публикация (планировщик)
- Мультипроектная публикация (Гинекология, Терапия, Педиатрия)
- Отслеживание расходов на публикации

### 4. Мониторинг и аналитика
- Мониторинг системных ресурсов
- Отслеживание операций AI
- Учет расходов по проектам и пользователям
- Журналирование всех операций

## Модели данных

### Основные сущности

#### Статьи (Article)
- Основная информация о новостной статье
- Связь с источником и метаданными
- Статус обработки

#### Пользователи (User)
- Аутентификация и авторизация
- Роли: admin, staff, analyst
- Привязка к проектам

#### Черновики новостей (NewsGenerationDraft)
- Сгенерированный контент
- SEO данные
- Статус публикации
- Планирование публикации

#### Расходы (Expense)
- Учет затрат на AI операции
- Привязка к пользователям и проектам
- Типы расходов: создание новостей, регенерация изображений, GPT сообщения

## Интеграции

### 1. AI Сервисы
- OpenAI GPT для генерации текста
- Различные провайдеры изображений
- Настраиваемые модели и параметры

### 2. Bitrix CMS
- Автоматическая публикация статей
- Управление проектами
- Загрузка изображений

### 3. Парсеры новостей
- Поддержка множественных источников
- Асинхронная обработка
- Обработка ошибок и retry логика

## Безопасность

### Аутентификация
- JWT токены для API доступа
- Хеширование паролей (bcrypt)
- Защищенные маршруты

### Авторизация
- Ролевая модель доступа
- Разграничение по проектам
- Rate limiting для API

### Валидация данных
- Pydantic модели для валидации
- Санитизация входных данных
- Проверка переменных окружения

## Конфигурация

### Переменные окружения
- База данных: `DATABASE_URL`
- AI сервисы: `OPENAI_API_KEY`
- Bitrix: `BITRIX_API_*`
- Безопасность: `JWT_SECRET_KEY`

### Настройки приложения
- Хранение в таблице `app_settings`
- Категоризация настроек
- Управление через админ панель

## Мониторинг и логирование

### Логирование
- Структурированные логи
- Разные уровни логирования
- Ротация логов

### Метрики
- Использование ресурсов системы
- Статистика операций
- Время выполнения запросов

### Health checks
- `/health` - общий статус системы
- `/api/health` - статус API
- Проверка подключения к БД

## Развертывание

### Разработка
- Docker контейнеры
- Hot reload для разработки
- Локальная SQLite база

### Продакшен
- PostgreSQL база данных
- Nginx как reverse proxy
- SSL сертификаты
- Мониторинг и алерты

## Планы развития

### Краткосрочные
- Улучшение UI/UX интерфейса
- Дополнительные источники новостей
- Расширенная аналитика

### Долгосрочные
- Микросервисная архитектура
- Кэширование (Redis)
- Масштабирование AI операций
- Интеграция с дополнительными CMS